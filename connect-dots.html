<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect the Dots</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
    <script src="js/themes.js"></script>
    <script src="js/rewards.js"></script>
    <script src="js/game-utils.js"></script>
    <style>
        :root {
            --primary-color: #00A8E8;
            --secondary-color: #0077B6;
            --accent-color: #06FFA5;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Arial', sans-serif;
        }
        #game-container {
            width: 980px;
            height: 760px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div id="game-container"></div>
    
    <script>
        // Load theme and apply
        const currentTheme = getCurrentTheme();
        const themeName = localStorage.getItem('currentTheme') || 'jellyfish';
        const activityType = sessionStorage.getItem('currentActivityType') || 'connect-dots';
        applyTheme(currentTheme);
        
        // Map activity type to difficulty level key
        const difficultyKey = 'dots'; // connect-dots maps to 'dots' in DIFFICULTY_LEVELS
        
        // Activity tracking (activityTracker is defined in rewards.js)
        let startTime;
        
        // Get difficulty level
        const difficultyLevel = getDifficultyLevel(difficultyKey);
        const difficultyConfig = DIFFICULTY_LEVELS[difficultyKey][difficultyLevel - 1];
        
        console.log('ðŸŽ® PHASER VERSION LOADED');
        console.log('Activity Type:', activityType, '(for rewards)');
        console.log('Difficulty Key:', difficultyKey, '(for progression)');
        console.log('Difficulty Level:', difficultyLevel);
        console.log('Difficulty Config:', difficultyConfig);
        console.log('LocalStorage key:', `difficulty_${difficultyKey}`);
        console.log('LocalStorage value:', localStorage.getItem(`difficulty_${difficultyKey}`));
        
        // Dot sets for different difficulties
        const dotSets = {
            1: [ // EASY - 15 dots (simple jellyfish)
                {num: 1, x: 300, y: 100}, {num: 2, x: 360, y: 90}, {num: 3, x: 420, y: 110},
                {num: 4, x: 450, y: 160}, {num: 5, x: 440, y: 220}, {num: 6, x: 380, y: 260},
                {num: 7, x: 320, y: 270}, {num: 8, x: 260, y: 250}, {num: 9, x: 220, y: 200},
                {num: 10, x: 230, y: 140}, {num: 11, x: 270, y: 110}, {num: 12, x: 300, y: 280},
                {num: 13, x: 290, y: 350}, {num: 14, x: 370, y: 280}, {num: 15, x: 380, y: 360}
            ],
            2: [ // MEDIUM - 20 dots (original)
                {num: 1, x: 280, y: 100}, {num: 2, x: 350, y: 80}, {num: 3, x: 420, y: 100},
                {num: 4, x: 450, y: 140}, {num: 5, x: 460, y: 190}, {num: 6, x: 450, y: 240},
                {num: 7, x: 400, y: 270}, {num: 8, x: 350, y: 280}, {num: 9, x: 300, y: 270},
                {num: 10, x: 250, y: 240}, {num: 11, x: 240, y: 190}, {num: 12, x: 250, y: 140},
                {num: 13, x: 280, y: 100}, {num: 14, x: 300, y: 280}, {num: 15, x: 290, y: 360},
                {num: 16, x: 350, y: 280}, {num: 17, x: 350, y: 380}, {num: 18, x: 400, y: 280},
                {num: 19, x: 410, y: 360}, {num: 20, x: 300, y: 100}
            ],
            3: [ // HARD - 25 dots (detailed jellyfish)
                {num: 1, x: 280, y: 100}, {num: 2, x: 320, y: 85}, {num: 3, x: 360, y: 80},
                {num: 4, x: 400, y: 90}, {num: 5, x: 430, y: 115}, {num: 6, x: 455, y: 150},
                {num: 7, x: 465, y: 195}, {num: 8, x: 460, y: 235}, {num: 9, x: 440, y: 265},
                {num: 10, x: 405, y: 280}, {num: 11, x: 365, y: 288}, {num: 12, x: 325, y: 285},
                {num: 13, x: 285, y: 275}, {num: 14, x: 250, y: 255}, {num: 15, x: 230, y: 220},
                {num: 16, x: 225, y: 180}, {num: 17, x: 235, y: 140}, {num: 18, x: 260, y: 110},
                {num: 19, x: 280, y: 100}, {num: 20, x: 285, y: 285}, {num: 21, x: 280, y: 360},
                {num: 22, x: 340, y: 288}, {num: 23, x: 340, y: 380}, {num: 24, x: 395, y: 285},
                {num: 25, x: 405, y: 365}
            ]
        };
        
        const dots = dotSets[difficultyLevel] || dotSets[1];
        let currentDot = 1;
        let completedPath = [];
        let titleText, instructionText, progressText;
        let dotSprites = [];
        let lineGraphics;
        let game;
        
        console.log('Total dots for this level:', dots.length);
        console.log('Expected dots:', difficultyConfig.count);
        
        const config = {
            type: Phaser.AUTO,
            parent: 'game-container',
            width: 980,
            height: 760,
            backgroundColor: '#FFFFFF',
            scene: {
                create: create,
                update: update
            }
        };
        
        // Initialize game
        game = new Phaser.Game(config);
        
        function create() {
            const scene = this;
            const sceneWidth = scene.scale.width;
            const sceneHeight = scene.scale.height;
            
            // Check if we should skip intro
            const skipIntro = sessionStorage.getItem('skipIntro') === 'true';
            if (skipIntro) {
                sessionStorage.removeItem('skipIntro');
                startGame(scene);
            } else {
                showIntro(scene);
            }
        }
        
        function showIntro(scene) {
            const sceneWidth = scene.scale.width;
            const sceneHeight = scene.scale.height;
            
            // Intro background
            const introBg = scene.add.rectangle(0, 0, sceneWidth, sceneHeight, 0x00A8E8, 1);
            introBg.setOrigin(0, 0);
            
            // Title
            const title = scene.add.text(sceneWidth / 2, sceneHeight * 0.3, 'Connect the Dots! (PHASER)', {
                fontSize: '48px',
                fontFamily: 'Arial',
                color: '#ffffff',
                fontStyle: 'bold'
            }).setOrigin(0.5);
            
            // Emoji
            const emoji = scene.add.text(sceneWidth / 2, sceneHeight * 0.45, 'âœï¸', {
                fontSize: '80px'
            }).setOrigin(0.5);
            
            // Instructions
            const instructions = scene.add.text(sceneWidth / 2, sceneHeight * 0.6, 
                `Connect the numbered dots in order to reveal the picture!\nLevel ${difficultyLevel}: ${difficultyConfig.name} | Dots: ${dots.length}`, {
                fontSize: '20px',
                fontFamily: 'Arial',
                color: '#ffffff',
                align: 'center'
            }).setOrigin(0.5);
            
            // Start button
            const startBtn = scene.add.rectangle(sceneWidth / 2, sceneHeight * 0.75, 200, 60, 0xFFFFFF);
            startBtn.setInteractive({ useHandCursor: true });
            const startText = scene.add.text(sceneWidth / 2, sceneHeight * 0.75, 'Start Drawing!', {
                fontSize: '24px',
                fontFamily: 'Arial',
                color: '#00A8E8',
                fontStyle: 'bold'
            }).setOrigin(0.5);
            
            startBtn.on('pointerdown', () => {
                introBg.destroy();
                title.destroy();
                emoji.destroy();
                instructions.destroy();
                startBtn.destroy();
                startText.destroy();
                startGame(scene);
            });
            
            startBtn.on('pointerover', () => {
                startBtn.setScale(1.05);
                startText.setScale(1.05);
            });
            
            startBtn.on('pointerout', () => {
                startBtn.setScale(1);
                startText.setScale(1);
            });
        }
        
        function startGame(scene) {
            const sceneWidth = scene.scale.width;
            const sceneHeight = scene.scale.height;
            
            startTime = Date.now();
            currentDot = 1;
            completedPath = [];
            
            // Title
            titleText = scene.add.text(sceneWidth / 2, 30, `Connect the Dots - ${currentTheme.name}`, {
                fontSize: '28px',
                fontFamily: 'Arial',
                color: '#' + currentTheme.colors.primary.toString(16),
                fontStyle: 'bold'
            }).setOrigin(0.5);
            
            // Instructions
            instructionText = scene.add.text(sceneWidth / 2, 65, 'Click the dots in order!', {
                fontSize: '18px',
                fontFamily: 'Arial',
                color: '#666666'
            }).setOrigin(0.5);
            
            // Progress
            progressText = scene.add.text(sceneWidth / 2, 95, `Dot: 1 / ${dots.length}`, {
                fontSize: '16px',
                fontFamily: 'Arial',
                color: '#333333'
            }).setOrigin(0.5);
            
            // Create line graphics
            lineGraphics = scene.add.graphics();
            
            // Create dots
            dots.forEach((dot, index) => {
                // Dot circle
                const circle = scene.add.circle(dot.x, dot.y + 50, 15, 0x667eea, 0.8);
                circle.setStrokeStyle(3, 0xFFFFFF);
                circle.setInteractive({ useHandCursor: true });
                circle.dotData = dot;
                
                // Dot number
                const number = scene.add.text(dot.x, dot.y + 50, dot.num, {
                    fontSize: '16px',
                    fontFamily: 'Arial',
                    color: '#ffffff',
                    fontStyle: 'bold'
                }).setOrigin(0.5);
                
                // Click handler
                circle.on('pointerdown', () => handleDotClick(scene, circle, dot));
                
                // Hover effect
                circle.on('pointerover', () => {
                    if (dot.num === currentDot) {
                        circle.setScale(1.2);
                        number.setScale(1.2);
                    }
                });
                
                circle.on('pointerout', () => {
                    circle.setScale(1);
                    number.setScale(1);
                });
                
                dotSprites.push({ circle, number, dot });
            });
            
            // Back button
            const backBtn = scene.add.rectangle(80, sceneHeight - 40, 140, 40, 0x667eea);
            backBtn.setInteractive({ useHandCursor: true });
            const backText = scene.add.text(80, sceneHeight - 40, 'â† Menu', {
                fontSize: '18px',
                fontFamily: 'Arial',
                color: '#ffffff'
            }).setOrigin(0.5);
            
            backBtn.on('pointerdown', () => {
                window.location.href = 'index.html';
            });
        }
        
        function handleDotClick(scene, circle, dot) {
            if (dot.num !== currentDot) {
                // Wrong dot - shake it
                scene.tweens.add({
                    targets: circle,
                    x: circle.x + 10,
                    duration: 50,
                    yoyo: true,
                    repeat: 3
                });
                return;
            }
            
            // Correct dot
            circle.setFillStyle(0x51cf66);
            completedPath.push({ x: dot.x, y: dot.y + 50 });
            
            // Draw line to previous dot
            if (completedPath.length > 1) {
                const prev = completedPath[completedPath.length - 2];
                const curr = completedPath[completedPath.length - 1];
                
                lineGraphics.lineStyle(3, 0x667eea, 1);
                lineGraphics.beginPath();
                lineGraphics.moveTo(prev.x, prev.y);
                lineGraphics.lineTo(curr.x, curr.y);
                lineGraphics.strokePath();
            }
            
            currentDot++;
            progressText.setText(`Dot: ${currentDot - 1} / ${dots.length}`);
            
            // Check completion
            if (currentDot > dots.length) {
                completeActivity(scene);
            }
        }
        
        function completeActivity(scene) {
            const sceneWidth = scene.scale.width;
            const sceneHeight = scene.scale.height;
            const timeSpent = Math.floor((Date.now() - startTime) / 1000);
            const score = 100;
            
            console.log('ðŸŽ‰ Activity completed!');
            console.log('Current difficulty before progression:', difficultyLevel);
            
            // Send completion data
            const result = sendCompletionToWix(activityType, score, timeSpent, themeName);
            const newDifficulty = progressDifficulty(difficultyKey);
            
            console.log('New difficulty after progression:', newDifficulty);
            console.log('Next time will have dots:', DIFFICULTY_LEVELS[difficultyKey][newDifficulty - 1].dots);
            
            // Show achievements
            if (result.newAchievements && result.newAchievements.length > 0) {
                setTimeout(() => {
                    result.newAchievements.forEach((achievement, index) => {
                        setTimeout(() => showAchievement(achievement), index * 300);
                    });
                }, 1000);
            }
            
            // Completion overlay
            const overlay = scene.add.rectangle(0, 0, sceneWidth, sceneHeight, 0x000000, 0.7);
            overlay.setOrigin(0, 0);
            
            // Emoji
            scene.add.text(sceneWidth / 2, sceneHeight * 0.35, 'ðŸŽ‰', {
                fontSize: '80px'
            }).setOrigin(0.5);
            
            // Title
            scene.add.text(sceneWidth / 2, sceneHeight * 0.5, 'Perfect!', {
                fontSize: '48px',
                fontFamily: 'Arial',
                color: '#ffffff',
                fontStyle: 'bold'
            }).setOrigin(0.5);
            
            // Time
            scene.add.text(sceneWidth / 2, sceneHeight * 0.58, `Time: ${timeSpent} seconds`, {
                fontSize: '20px',
                fontFamily: 'Arial',
                color: '#ffffff'
            }).setOrigin(0.5);
            
            // Buttons
            const btnY = sceneHeight * 0.72;
            const btnSpacing = 180;
            
            // Next Level button
            const nextBtn = scene.add.rectangle(sceneWidth / 2 - btnSpacing / 2, btnY, 160, 50, 0x51cf66);
            nextBtn.setInteractive({ useHandCursor: true });
            const nextText = scene.add.text(sceneWidth / 2 - btnSpacing / 2, btnY, 'Next Level â¬†ï¸', {
                fontSize: '18px',
                fontFamily: 'Arial',
                color: '#ffffff',
                fontStyle: 'bold'
            }).setOrigin(0.5);
            
            nextBtn.on('pointerdown', () => {
                sessionStorage.setItem('skipIntro', 'true');
                location.reload();
            });
            
            // Back to Menu button
            const backBtn = scene.add.rectangle(sceneWidth / 2 + btnSpacing / 2, btnY, 160, 50, 0x667eea);
            backBtn.setInteractive({ useHandCursor: true });
            const backText = scene.add.text(sceneWidth / 2 + btnSpacing / 2, btnY, 'â† Menu', {
                fontSize: '18px',
                fontFamily: 'Arial',
                color: '#ffffff',
                fontStyle: 'bold'
            }).setOrigin(0.5);
            
            backBtn.on('pointerdown', () => {
                window.location.href = 'index.html';
            });
        }
        
        function update() {
            // Game loop if needed
        }
    </script>
</body>
</html>
