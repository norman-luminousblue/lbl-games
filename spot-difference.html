<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spot the Difference - Find What's Changed!</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.js"></script>
    <script src="js/themes.js"></script>
    <script src="js/rewards.js"></script>
    <script src="js/game-utils.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Comic Sans MS', cursive, sans-serif;
        }
        #game-container {
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="game-container"></div>
    
    <script>
        console.log('ðŸŽ® SPOT DIFFERENCE PHASER VERSION LOADED');
        
        // Activity configuration
        const activityType = 'spot-difference';
        const difficultyKey = 'difference';
        
        // Load theme
        const currentTheme = getCurrentTheme();
        const themeName = localStorage.getItem('currentTheme') || 'jellyfish';
        applyTheme(currentTheme);
        
        // Get difficulty level
        const difficultyLevel = getDifficultyLevel(difficultyKey);
        const difficultyConfig = DIFFICULTY_LEVELS[difficultyKey][difficultyLevel - 1];
        
        console.log('ðŸ“Š Difficulty Level:', difficultyLevel);
        console.log('ðŸ“‹ Config:', difficultyConfig);
        
        const gameWidth = 900;
        const gameHeight = 600;
        const sceneWidth = 400;
        const sceneHeight = 350;
        
        let gameScene;
        let foundDifferences = [];
        let startTime;
        let markerGraphics;
        
        // Difference definitions based on difficulty
        const differenceSets = {
            1: [ // EASY - 5 differences
                {x: 100, y: 80, r: 25, type: 'star'},
                {x: 300, y: 120, r: 30, type: 'fish-color'},
                {x: 350, y: 250, r: 30, type: 'shell'},
                {x: 150, y: 280, r: 25, type: 'seaweed'},
                {x: 265, y: 170, r: 20, type: 'eye'}
            ],
            2: [ // MEDIUM - 7 differences
                {x: 100, y: 80, r: 25, type: 'star'},
                {x: 300, y: 120, r: 30, type: 'fish-color'},
                {x: 350, y: 250, r: 30, type: 'shell'},
                {x: 150, y: 280, r: 25, type: 'seaweed'},
                {x: 265, y: 170, r: 20, type: 'eye'},
                {x: 60, y: 50, r: 20, type: 'bubble'},
                {x: 500, y: 300, r: 25, type: 'coral'}
            ],
            3: [ // HARD - 10 differences
                {x: 100, y: 80, r: 25, type: 'star'},
                {x: 300, y: 120, r: 30, type: 'fish-color'},
                {x: 350, y: 250, r: 30, type: 'shell'},
                {x: 150, y: 280, r: 25, type: 'seaweed'},
                {x: 265, y: 170, r: 20, type: 'eye'},
                {x: 60, y: 50, r: 20, type: 'bubble'},
                {x: 80, y: 320, r: 20, type: 'rock'},
                {x: 340, y: 110, r: 22, type: 'fish-tail'},
                {x: 200, y: 320, r: 20, type: 'rock2'},
                {x: 180, y: 50, r: 18, type: 'bubble2'}
            ]
        };
        
        const differences = differenceSets[difficultyLevel] || differenceSets[1];
        const totalDifferences = differences.length;
        
        // Phaser configuration
        const config = {
            type: Phaser.AUTO,
            width: gameWidth,
            height: gameHeight,
            parent: 'game-container',
            backgroundColor: '#E8F4F8',
            scene: {
                create: create,
                update: update
            }
        };
        
        const game = new Phaser.Game(config);
        
        function create() {
            gameScene = this;
            
            // Check if we should skip intro
            if (sessionStorage.getItem('skipIntro') === 'true') {
                sessionStorage.removeItem('skipIntro');
                startGame();
            } else {
                showIntro();
            }
        }
        
        function showIntro() {
            // Background
            const bg = gameScene.add.graphics();
            bg.fillStyle(0x00A8E8, 1);
            bg.fillRect(0, 0, gameWidth, gameHeight);
            
            // Title
            const titleText = gameScene.add.text(gameWidth / 2, 100, 'Spot the Difference!', {
                fontSize: '52px',
                fontFamily: 'Arial',
                color: '#ffffff',
                fontStyle: 'bold'
            });
            titleText.setOrigin(0.5);
            
            // Emoji
            const emoji = gameScene.add.text(gameWidth / 2, 180, 'ðŸ”ðŸª¼', {
                fontSize: '72px'
            });
            emoji.setOrigin(0.5);
            
            // Instructions
            const difficultyText = difficultyConfig.name || 'Easy';
            const instructions = gameScene.add.text(gameWidth / 2, gameHeight / 2, 
                `Level: ${difficultyText}\n\nFind ${totalDifferences} differences between the two scenes!\n\nClick or tap on the differences`, {
                fontSize: '22px',
                fontFamily: 'Arial',
                color: '#ffffff',
                align: 'center',
                lineSpacing: 10
            });
            instructions.setOrigin(0.5);
            
            // Start button
            const button = gameScene.add.graphics();
            button.fillStyle(0x06FFA5, 1);
            button.fillRoundedRect(gameWidth / 2 - 100, gameHeight / 2 + 110, 200, 60, 10);
            
            const buttonText = gameScene.add.text(gameWidth / 2, gameHeight / 2 + 140, 'Start Game', {
                fontSize: '28px',
                fontFamily: 'Arial',
                color: '#1D3557',
                fontStyle: 'bold'
            });
            buttonText.setOrigin(0.5);
            
            // Make button interactive
            const buttonZone = gameScene.add.zone(gameWidth / 2, gameHeight / 2 + 140, 200, 60);
            buttonZone.setInteractive({ useHandCursor: true });
            buttonZone.on('pointerdown', () => {
                bg.destroy();
                titleText.destroy();
                emoji.destroy();
                instructions.destroy();
                button.destroy();
                buttonText.destroy();
                buttonZone.destroy();
                startGame();
            });
            
            // Back button
            const backButton = gameScene.add.text(20, 20, 'â† Back', {
                fontSize: '24px',
                fontFamily: 'Arial',
                color: '#ffffff'
            });
            backButton.setInteractive({ useHandCursor: true });
            backButton.on('pointerdown', () => {
                window.location.href = 'index.html';
            });
        }
        
        function startGame() {
            startTime = Date.now();
            foundDifferences = [];
            
            // Title
            const title = gameScene.add.text(gameWidth / 2, 25, 'ðŸ” Find the Differences! ðŸ”', {
                fontSize: '28px',
                fontFamily: 'Arial',
                color: '#1D3557',
                fontStyle: 'bold'
            });
            title.setOrigin(0.5);
            title.setDepth(100);
            
            // Progress text
            const progressText = gameScene.add.text(gameWidth / 2, 60, `Found: 0/${totalDifferences}`, {
                fontSize: '24px',
                fontFamily: 'Arial',
                color: '#00A8E8',
                fontStyle: 'bold'
            });
            progressText.setOrigin(0.5);
            progressText.setDepth(100);
            progressText.name = 'progressText';
            
            // Scene labels
            const label1 = gameScene.add.text(50 + sceneWidth / 2, 100, 'Original Scene', {
                fontSize: '20px',
                fontFamily: 'Arial',
                color: '#457B9D',
                fontStyle: 'bold'
            });
            label1.setOrigin(0.5);
            label1.setDepth(100);
            
            const label2 = gameScene.add.text(450 + sceneWidth / 2, 100, 'Find Differences Here', {
                fontSize: '20px',
                fontFamily: 'Arial',
                color: '#457B9D',
                fontStyle: 'bold'
            });
            label2.setOrigin(0.5);
            label2.setDepth(100);
            
            // Draw both scenes
            drawScene(50, 130, true);
            drawScene(450, 130, false);
            
            // Create marker graphics layer
            markerGraphics = gameScene.add.graphics();
            markerGraphics.setDepth(50);
            
            // Setup interactive areas for both scenes
            setupInteractiveAreas(50, 130);
            setupInteractiveAreas(450, 130);
        }
        
        function drawScene(offsetX, offsetY, isOriginal) {
            const graphics = gameScene.add.graphics();
            graphics.setPosition(offsetX, offsetY);
            
            // Ocean background gradient
            graphics.fillGradientStyle(0xA8DADC, 0xA8DADC, 0x457B9D, 0x457B9D, 1);
            graphics.fillRect(0, 0, sceneWidth, sceneHeight);
            
            // Bubbles
            graphics.fillStyle(0xFFFFFF, 0.3);
            [60, 180, 320].forEach((x, i) => {
                const radius = (isOriginal || foundDifferences.includes(5)) ? 15 : 10;
                if (i === 0 && !isOriginal && !foundDifferences.includes(5)) {
                    graphics.fillCircle(x, 50 + i * 30, radius);
                } else if (i === 1 && !isOriginal && !foundDifferences.includes(9)) {
                    // Bubble 2 difference
                    graphics.fillCircle(x, 50 + i * 30, 10);
                } else {
                    graphics.fillCircle(x, 50 + i * 30, 15);
                }
            });
            
            // Star (difference 0) - missing in picture 2
            if (isOriginal || foundDifferences.includes(0)) {
                graphics.fillStyle(0xF7931E, 1);
                drawStar(graphics, 100, 80, 5, 15, 7);
            }
            
            // Small fish (difference 1) - color changes
            const fishColor = (isOriginal || foundDifferences.includes(1)) ? 0xFF6B35 : 0x06FFA5;
            graphics.fillStyle(fishColor, 1);
            graphics.fillEllipse(300, 120, 50, 30);
            
            // Fish tail (difference 7)
            const tailSize = (isOriginal || foundDifferences.includes(7)) ? 15 : 10;
            graphics.beginPath();
            graphics.moveTo(325, 120);
            graphics.lineTo(340, 110);
            graphics.lineTo(340, 130);
            graphics.closePath();
            graphics.fillPath();
            
            // Jellyfish (center)
            graphics.fillStyle(0xA8DADC, 0.8);
            graphics.slice(250, 180, 40, 0, Math.PI, false);
            graphics.fillPath();
            
            // Jellyfish eyes
            graphics.fillStyle(0x333333, 1);
            graphics.fillCircle(235, 170, 4);
            
            // Second eye (difference 4) - missing in picture 2
            if (isOriginal || foundDifferences.includes(4)) {
                graphics.fillCircle(265, 170, 4);
            }
            
            // Tentacles
            graphics.lineStyle(5, 0xA8DADC, 0.8);
            [230, 250, 270].forEach(x => {
                graphics.beginPath();
                graphics.moveTo(x, 220);
                graphics.lineTo(x - 10, 280);
                graphics.strokePath();
            });
            
            // Seaweed (difference 3) - shorter in picture 2
            graphics.fillStyle(0x2A9D8F, 1);
            const seaweedHeight = (isOriginal || foundDifferences.includes(3)) ? 100 : 60;
            graphics.fillRect(145, 350 - seaweedHeight, 15, seaweedHeight);
            
            // Ocean floor
            graphics.fillStyle(0x1D3557, 1);
            graphics.fillRect(0, 300, sceneWidth, 50);
            
            // Shell (difference 2) - missing in picture 2
            if (isOriginal || foundDifferences.includes(2)) {
                graphics.fillStyle(0xE9C46A, 1);
                graphics.slice(350, 250, 20, 0, Math.PI, false);
                graphics.fillPath();
                
                // Shell lines
                graphics.lineStyle(2, 0xCA8A04, 1);
                for (let i = 0; i < 5; i++) {
                    graphics.beginPath();
                    graphics.moveTo(350 - 15 + i * 7.5, 250);
                    graphics.lineTo(350 - 15 + i * 7.5, 235);
                    graphics.strokePath();
                }
            }
            
            // Rocks (difference 6 and 8)
            const rock1Color = (isOriginal || foundDifferences.includes(6)) ? 0x6C757D : 0x8B9AA3;
            const rock2Color = (isOriginal || foundDifferences.includes(8)) ? 0x6C757D : 0x8B9AA3;
            
            graphics.fillStyle(rock1Color, 1);
            graphics.slice(80, 320, 15, 0, Math.PI, false);
            graphics.fillPath();
            
            graphics.fillStyle(rock2Color, 1);
            graphics.slice(200, 320, 18, 0, Math.PI, false);
            graphics.fillPath();
            
            graphics.fillStyle(0x6C757D, 1);
            graphics.slice(320, 320, 21, 0, Math.PI, false);
            graphics.fillPath();
        }
        
        function drawStar(graphics, x, y, points, outer, inner) {
            graphics.beginPath();
            for (let i = 0; i < points * 2; i++) {
                const radius = i % 2 === 0 ? outer : inner;
                const angle = (i * Math.PI) / points - Math.PI / 2;
                const px = x + Math.cos(angle) * radius;
                const py = y + Math.sin(angle) * radius;
                if (i === 0) graphics.moveTo(px, py);
                else graphics.lineTo(px, py);
            }
            graphics.closePath();
            graphics.fillPath();
        }
        
        function setupInteractiveAreas(offsetX, offsetY) {
            differences.forEach((diff, index) => {
                const zone = gameScene.add.zone(offsetX + diff.x, offsetY + diff.y, diff.r * 2, diff.r * 2);
                zone.setInteractive(new Phaser.Geom.Circle(diff.r, diff.r, diff.r), Phaser.Geom.Circle.Contains);
                zone.on('pointerdown', () => {
                    checkDifference(index, offsetX, offsetY);
                });
            });
        }
        
        function checkDifference(index, offsetX, offsetY) {
            if (foundDifferences.includes(index)) return;
            
            foundDifferences.push(index);
            
            // Mark the difference on both scenes
            const diff = differences[index];
            
            // Draw circles on both scenes
            markerGraphics.lineStyle(3, 0x06FFA5, 1);
            markerGraphics.strokeCircle(50 + diff.x, 130 + diff.y, diff.r);
            markerGraphics.strokeCircle(450 + diff.x, 130 + diff.y, diff.r);
            
            // Update progress
            const progressText = gameScene.children.list.find(child => child.name === 'progressText');
            if (progressText) {
                progressText.setText(`Found: ${foundDifferences.length}/${totalDifferences}`);
            }
            
            // Redraw scenes to show the difference revealed
            gameScene.children.list.forEach(child => {
                if (child.type === 'Graphics' && child !== markerGraphics) {
                    child.destroy();
                }
            });
            drawScene(50, 130, true);
            drawScene(450, 130, false);
            
            // Redraw all markers
            markerGraphics.clear();
            foundDifferences.forEach(idx => {
                const d = differences[idx];
                markerGraphics.lineStyle(3, 0x06FFA5, 1);
                markerGraphics.strokeCircle(50 + d.x, 130 + d.y, d.r);
                markerGraphics.strokeCircle(450 + d.x, 130 + d.y, d.r);
            });
            
            // Check if all found
            if (foundDifferences.length === totalDifferences) {
                setTimeout(completeGame, 500);
            }
        }
        
        function completeGame() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            startTime = null;
            
            // Clear scene
            gameScene.children.removeAll();
            
            // Show completion screen
            const overlay = gameScene.add.graphics();
            overlay.fillStyle(0x00A8E8, 0.95);
            overlay.fillRect(0, 0, gameWidth, gameHeight);
            overlay.setDepth(200);
            
            const successText = gameScene.add.text(gameWidth / 2, gameHeight / 2 - 120, 'ðŸŽ‰ Perfect! ðŸŽ‰', {
                fontSize: '52px',
                fontFamily: 'Arial',
                color: '#ffffff',
                fontStyle: 'bold'
            });
            successText.setOrigin(0.5);
            successText.setDepth(201);
            
            const completionText = gameScene.add.text(gameWidth / 2, gameHeight / 2 - 40, 
                `You found all ${totalDifferences} differences in ${elapsed} seconds!\n\nAmazing detective work!`, {
                fontSize: '24px',
                fontFamily: 'Arial',
                color: '#ffffff',
                align: 'center',
                lineSpacing: 10
            });
            completionText.setOrigin(0.5);
            completionText.setDepth(201);
            
            // Calculate score
            const score = Math.max(100 - elapsed, 10);
            const result = sendCompletionToWix(activityType, score, elapsed, themeName);
            
            console.log('ðŸŽ¯ Completion result:', result);
            console.log('ðŸ“Š Current difficulty before progression:', difficultyLevel);
            
            // Progress difficulty
            const oldDiff = getDifficultyLevel(difficultyKey);
            progressDifficulty(difficultyKey);
            const newDiff = getDifficultyLevel(difficultyKey);
            
            console.log('ðŸ“ˆ Difficulty progression:', oldDiff, 'â†’', newDiff);
            
            // Check if we've reached max difficulty
            const maxDifficulty = DIFFICULTY_LEVELS[difficultyKey].length;
            const hasMoreLevels = newDiff < maxDifficulty;
            
            console.log('ðŸŽ¯ Max difficulty:', maxDifficulty, '| Has more levels:', hasMoreLevels);
            
            // Show achievements
            if (result.newAchievements && result.newAchievements.length > 0) {
                setTimeout(() => {
                    result.newAchievements.forEach((achievement, index) => {
                        setTimeout(() => showAchievement(achievement), index * 300);
                    });
                }, 1000);
            }
            
            // Next Level or completion button
            if (hasMoreLevels) {
                const nextButton = gameScene.add.graphics();
                nextButton.fillStyle(0x06FFA5, 1);
                nextButton.fillRoundedRect(gameWidth / 2 - 100, gameHeight / 2 + 60, 200, 60, 10);
                nextButton.setDepth(201);
                
                const nextText = gameScene.add.text(gameWidth / 2, gameHeight / 2 + 90, 'Next Level', {
                    fontSize: '28px',
                    fontFamily: 'Arial',
                    color: '#1D3557',
                    fontStyle: 'bold'
                });
                nextText.setOrigin(0.5);
                nextText.setDepth(202);
                nextText.setInteractive({ useHandCursor: true });
                nextText.on('pointerdown', () => {
                    console.log('Next Level clicked - reloading with difficulty:', newDiff);
                    sessionStorage.setItem('skipIntro', 'true');
                    location.reload();
                });
            } else {
                const completeText = gameScene.add.text(gameWidth / 2, gameHeight / 2 + 90, 'ðŸ† All Levels Complete! ðŸ†', {
                    fontSize: '24px',
                    fontFamily: 'Arial',
                    color: '#06FFA5',
                    fontStyle: 'bold'
                });
                completeText.setOrigin(0.5);
                completeText.setDepth(202);
            }
            
            // Back to menu button
            const backText = gameScene.add.text(gameWidth / 2, gameHeight / 2 + 160, 'â† Back to Menu', {
                fontSize: '20px',
                fontFamily: 'Arial',
                color: '#ffffff'
            });
            backText.setOrigin(0.5);
            backText.setDepth(202);
            backText.setInteractive({ useHandCursor: true });
            backText.on('pointerdown', () => {
                console.log('Back to Menu clicked');
                window.location.href = 'index.html';
            });
        }
        
        function update() {
            // Game loop
        }
    </script>
</body>
</html>
