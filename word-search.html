<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Search - Find Ocean Words!</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.js"></script>
    <script src="js/themes.js"></script>
    <script src="js/rewards.js"></script>
    <script src="js/game-utils.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Comic Sans MS', cursive, sans-serif;
        }
        #game-container {
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="game-container"></div>
    
    <script>
        console.log('ðŸŽ® WORD SEARCH PHASER VERSION LOADED');
        
        // Activity configuration
        const activityType = 'word-search';
        const difficultyKey = 'wordSearch';
        
        // Load theme
        const currentTheme = getCurrentTheme();
        const themeName = localStorage.getItem('currentTheme') || 'jellyfish';
        applyTheme(currentTheme);
        
        // Get difficulty level
        const difficultyLevel = getDifficultyLevel(difficultyKey);
        const difficultyConfig = DIFFICULTY_LEVELS[difficultyKey][difficultyLevel - 1];
        
        console.log('ðŸ“Š Difficulty Level:', difficultyLevel);
        console.log('ðŸ“‹ Config:', difficultyConfig);
        
        const gridSize = difficultyConfig.gridSize;
        const cellSize = 40;
        const gridWidth = gridSize * cellSize;
        const gameWidth = gridWidth + 300; // Extra space for word list
        const gameHeight = gridWidth + 150;
        
        let gameScene;
        let grid = [];
        let words = [];
        let wordPositions = [];
        let foundWords = [];
        let startTime;
        let selectionGraphics;
        let isSelecting = false;
        let startCell = null;
        let currentCell = null;
        let wordTexts = {};
        
        // Theme words
        const themeWords = currentTheme.words || [
            'JELLYFISH', 'OCEAN', 'CORAL', 'WAVE', 'SHELL', 'FISH', 'CRAB', 'STAR',
            'WATER', 'BLUE', 'SEA', 'TIDE', 'REEF', 'SAND'
        ];
        
        words = themeWords.slice(0, difficultyConfig.words);
        
        // Phaser configuration
        const config = {
            type: Phaser.AUTO,
            width: gameWidth,
            height: gameHeight,
            parent: 'game-container',
            backgroundColor: '#E8F4F8',
            scene: {
                create: create,
                update: update
            }
        };
        
        const game = new Phaser.Game(config);
        
        function create() {
            gameScene = this;
            
            // Check if we should skip intro
            if (sessionStorage.getItem('skipIntro') === 'true') {
                sessionStorage.removeItem('skipIntro');
                startGame();
            } else {
                showIntro();
            }
        }
        
        function showIntro() {
            // Background
            const bg = gameScene.add.graphics();
            bg.fillStyle(0x00A8E8, 1);
            bg.fillRect(0, 0, gameWidth, gameHeight);
            
            // Title
            const titleText = gameScene.add.text(gameWidth / 2, 100, 'Word Search!', {
                fontSize: '52px',
                fontFamily: 'Arial',
                color: '#ffffff',
                fontStyle: 'bold'
            });
            titleText.setOrigin(0.5);
            
            // Emoji
            const emoji = gameScene.add.text(gameWidth / 2, 180, 'ðŸ”¤ðŸª¼', {
                fontSize: '72px'
            });
            emoji.setOrigin(0.5);
            
            // Instructions
            const difficultyText = difficultyConfig.name || 'Easy';
            const instructions = gameScene.add.text(gameWidth / 2, gameHeight / 2, 
                `Level: ${difficultyText} (${gridSize}x${gridSize} grid)\n\nFind ${words.length} ocean words!\n\nDrag from start to end of each word\n(horizontal, vertical, or diagonal)`, {
                fontSize: '22px',
                fontFamily: 'Arial',
                color: '#ffffff',
                align: 'center',
                lineSpacing: 10
            });
            instructions.setOrigin(0.5);
            
            // Start button
            const button = gameScene.add.graphics();
            button.fillStyle(0x06FFA5, 1);
            button.fillRoundedRect(gameWidth / 2 - 100, gameHeight / 2 + 120, 200, 60, 10);
            
            const buttonText = gameScene.add.text(gameWidth / 2, gameHeight / 2 + 150, 'Start Game', {
                fontSize: '28px',
                fontFamily: 'Arial',
                color: '#1D3557',
                fontStyle: 'bold'
            });
            buttonText.setOrigin(0.5);
            
            // Make button interactive
            const buttonZone = gameScene.add.zone(gameWidth / 2, gameHeight / 2 + 150, 200, 60);
            buttonZone.setInteractive({ useHandCursor: true });
            buttonZone.on('pointerdown', () => {
                bg.destroy();
                titleText.destroy();
                emoji.destroy();
                instructions.destroy();
                button.destroy();
                buttonText.destroy();
                buttonZone.destroy();
                startGame();
            });
            
            // Back button
            const backButton = gameScene.add.text(20, 20, 'â† Back', {
                fontSize: '24px',
                fontFamily: 'Arial',
                color: '#ffffff'
            });
            backButton.setInteractive({ useHandCursor: true });
            backButton.on('pointerdown', () => {
                window.location.href = 'index.html';
            });
        }
        
        function startGame() {
            startTime = Date.now();
            foundWords = [];
            wordTexts = {};
            
            // Title
            const title = gameScene.add.text(gameWidth / 2, 25, 'ðŸ”¤ Find All the Words! ðŸ”¤', {
                fontSize: '28px',
                fontFamily: 'Arial',
                color: '#1D3557',
                fontStyle: 'bold'
            });
            title.setOrigin(0.5);
            title.setDepth(100);
            
            // Progress text
            const progressText = gameScene.add.text(gameWidth / 2, 60, `Found: 0/${words.length}`, {
                fontSize: '24px',
                fontFamily: 'Arial',
                color: '#00A8E8',
                fontStyle: 'bold'
            });
            progressText.setOrigin(0.5);
            progressText.setDepth(100);
            progressText.name = 'progressText';
            
            // Generate grid
            createGrid();
            placeWords();
            fillRandomLetters();
            
            // Draw grid
            drawGrid();
            
            // Draw word list
            drawWordList();
            
            // Create selection graphics
            selectionGraphics = gameScene.add.graphics();
            selectionGraphics.setDepth(50);
            
            // Setup input
            setupInput();
        }
        
        function createGrid() {
            grid = [];
            for (let i = 0; i < gridSize; i++) {
                grid[i] = [];
                for (let j = 0; j < gridSize; j++) {
                    grid[i][j] = '';
                }
            }
        }
        
        function placeWords() {
            wordPositions = [];
            
            words.forEach(word => {
                let placed = false;
                let attempts = 0;
                
                while (!placed && attempts < 100) {
                    const direction = Math.floor(Math.random() * 3);
                    const row = Math.floor(Math.random() * gridSize);
                    const col = Math.floor(Math.random() * gridSize);
                    
                    if (canPlaceWord(word, row, col, direction)) {
                        placeWord(word, row, col, direction);
                        placed = true;
                    }
                    attempts++;
                }
            });
        }
        
        function canPlaceWord(word, row, col, direction) {
            const len = word.length;
            
            if (direction === 0) { // Horizontal
                if (col + len > gridSize) return false;
                for (let i = 0; i < len; i++) {
                    if (grid[row][col + i] && grid[row][col + i] !== word[i]) return false;
                }
            } else if (direction === 1) { // Vertical
                if (row + len > gridSize) return false;
                for (let i = 0; i < len; i++) {
                    if (grid[row + i][col] && grid[row + i][col] !== word[i]) return false;
                }
            } else { // Diagonal
                if (row + len > gridSize || col + len > gridSize) return false;
                for (let i = 0; i < len; i++) {
                    if (grid[row + i][col + i] && grid[row + i][col + i] !== word[i]) return false;
                }
            }
            
            return true;
        }
        
        function placeWord(word, row, col, direction) {
            const positions = [];
            
            for (let i = 0; i < word.length; i++) {
                if (direction === 0) {
                    grid[row][col + i] = word[i];
                    positions.push({row, col: col + i});
                } else if (direction === 1) {
                    grid[row + i][col] = word[i];
                    positions.push({row: row + i, col});
                } else {
                    grid[row + i][col + i] = word[i];
                    positions.push({row: row + i, col: col + i});
                }
            }
            
            wordPositions.push({word, positions});
        }
        
        function fillRandomLetters() {
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    if (!grid[i][j]) {
                        grid[i][j] = letters[Math.floor(Math.random() * letters.length)];
                    }
                }
            }
        }
        
        function drawGrid() {
            const offsetX = 50;
            const offsetY = 100;
            
            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    const x = offsetX + j * cellSize;
                    const y = offsetY + i * cellSize;
                    
                    // Cell background
                    const cell = gameScene.add.graphics();
                    cell.fillStyle(0xE8F4F8, 1);
                    cell.fillRect(x, y, cellSize, cellSize);
                    cell.lineStyle(1, 0x00A8E8, 1);
                    cell.strokeRect(x, y, cellSize, cellSize);
                    cell.name = `cell_${i}_${j}`;
                    
                    // Letter
                    const letter = gameScene.add.text(x + cellSize / 2, y + cellSize / 2, grid[i][j], {
                        fontSize: '20px',
                        fontFamily: 'Arial',
                        color: '#333333',
                        fontStyle: 'bold'
                    });
                    letter.setOrigin(0.5);
                    letter.name = `letter_${i}_${j}`;
                    
                    // Interactive zone
                    const zone = gameScene.add.zone(x + cellSize / 2, y + cellSize / 2, cellSize, cellSize);
                    zone.setInteractive({ useHandCursor: true });
                    zone.row = i;
                    zone.col = j;
                }
            }
        }
        
        function drawWordList() {
            const listX = gridWidth + 80;
            const listY = 120;
            
            // Background
            const bg = gameScene.add.graphics();
            bg.fillStyle(0xE8F4F8, 1);
            bg.fillRoundedRect(listX - 20, listY - 30, 220, 50 + words.length * 35, 10);
            bg.lineStyle(3, 0x00A8E8, 1);
            bg.strokeRoundedRect(listX - 20, listY - 30, 220, 50 + words.length * 35, 10);
            bg.setDepth(10);
            
            // Title
            const titleText = gameScene.add.text(listX + 90, listY, 'Words to Find', {
                fontSize: '20px',
                fontFamily: 'Arial',
                color: '#00A8E8',
                fontStyle: 'bold'
            });
            titleText.setOrigin(0.5);
            titleText.setDepth(11);
            
            // Word list
            words.forEach((word, index) => {
                const wordText = gameScene.add.text(listX, listY + 40 + index * 35, word, {
                    fontSize: '18px',
                    fontFamily: 'Arial',
                    color: '#333333'
                });
                wordText.setDepth(11);
                wordTexts[word] = wordText;
            });
        }
        
        function setupInput() {
            gameScene.input.on('pointerdown', (pointer) => {
                const cell = getCellFromPointer(pointer);
                if (cell) {
                    isSelecting = true;
                    startCell = cell;
                    currentCell = cell;
                }
            });
            
            gameScene.input.on('pointermove', (pointer) => {
                if (isSelecting) {
                    const cell = getCellFromPointer(pointer);
                    if (cell) {
                        currentCell = cell;
                        drawSelection();
                    }
                }
            });
            
            gameScene.input.on('pointerup', () => {
                if (isSelecting) {
                    isSelecting = false;
                    checkSelection();
                    startCell = null;
                    currentCell = null;
                    selectionGraphics.clear();
                }
            });
        }
        
        function getCellFromPointer(pointer) {
            const offsetX = 50;
            const offsetY = 100;
            
            if (pointer.x < offsetX || pointer.x > offsetX + gridWidth ||
                pointer.y < offsetY || pointer.y > offsetY + gridWidth) {
                return null;
            }
            
            const col = Math.floor((pointer.x - offsetX) / cellSize);
            const row = Math.floor((pointer.y - offsetY) / cellSize);
            
            if (row >= 0 && row < gridSize && col >= 0 && col < gridSize) {
                return {row, col};
            }
            
            return null;
        }
        
        function drawSelection() {
            if (!startCell || !currentCell) return;
            
            const offsetX = 50;
            const offsetY = 100;
            
            selectionGraphics.clear();
            selectionGraphics.lineStyle(4, 0xF7931E, 0.7);
            selectionGraphics.beginPath();
            selectionGraphics.moveTo(
                offsetX + startCell.col * cellSize + cellSize / 2,
                offsetY + startCell.row * cellSize + cellSize / 2
            );
            selectionGraphics.lineTo(
                offsetX + currentCell.col * cellSize + cellSize / 2,
                offsetY + currentCell.row * cellSize + cellSize / 2
            );
            selectionGraphics.strokePath();
        }
        
        function checkSelection() {
            if (!startCell || !currentCell) return;
            
            const selectedWord = getSelectedWord();
            
            wordPositions.forEach(wordData => {
                if (wordData.word === selectedWord && !foundWords.includes(wordData)) {
                    foundWords.push(wordData);
                    markWordFound(wordData);
                    
                    // Update progress
                    const progressText = gameScene.children.list.find(child => child.name === 'progressText');
                    if (progressText) {
                        progressText.setText(`Found: ${foundWords.length}/${words.length}`);
                    }
                    
                    // Check completion
                    if (foundWords.length === words.length) {
                        setTimeout(completeGame, 500);
                    }
                }
            });
        }
        
        function getSelectedWord() {
            if (!startCell || !currentCell) return '';
            
            const rowDiff = currentCell.row - startCell.row;
            const colDiff = currentCell.col - startCell.col;
            const steps = Math.max(Math.abs(rowDiff), Math.abs(colDiff));
            
            if (steps === 0) return grid[startCell.row][startCell.col];
            
            const rowStep = rowDiff === 0 ? 0 : rowDiff / Math.abs(rowDiff);
            const colStep = colDiff === 0 ? 0 : colDiff / Math.abs(colDiff);
            
            let word = '';
            for (let i = 0; i <= steps; i++) {
                const row = startCell.row + i * rowStep;
                const col = startCell.col + i * colStep;
                if (row >= 0 && row < gridSize && col >= 0 && col < gridSize) {
                    word += grid[row][col];
                }
            }
            
            return word;
        }
        
        function markWordFound(wordData) {
            const offsetX = 50;
            const offsetY = 100;
            
            // Highlight cells
            wordData.positions.forEach(pos => {
                const x = offsetX + pos.col * cellSize;
                const y = offsetY + pos.row * cellSize;
                
                const highlight = gameScene.add.graphics();
                highlight.fillStyle(0x06FFA5, 1);
                highlight.fillRect(x, y, cellSize, cellSize);
                highlight.lineStyle(1, 0x00A8E8, 1);
                highlight.strokeRect(x, y, cellSize, cellSize);
                highlight.setDepth(-1);
            });
            
            // Update word list
            const wordText = wordTexts[wordData.word];
            if (wordText) {
                wordText.setColor('#ffffff');
                wordText.setBackgroundColor('#06FFA5');
                wordText.setPadding(4);
                wordText.setStyle({ textDecoration: 'line-through' });
            }
        }
        
        function completeGame() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            startTime = null;
            
            // Clear scene
            gameScene.children.removeAll();
            
            // Show completion screen
            const overlay = gameScene.add.graphics();
            overlay.fillStyle(0x00A8E8, 0.95);
            overlay.fillRect(0, 0, gameWidth, gameHeight);
            overlay.setDepth(200);
            
            const successText = gameScene.add.text(gameWidth / 2, gameHeight / 2 - 120, 'ðŸŽ‰ Excellent! ðŸŽ‰', {
                fontSize: '52px',
                fontFamily: 'Arial',
                color: '#ffffff',
                fontStyle: 'bold'
            });
            successText.setOrigin(0.5);
            successText.setDepth(201);
            
            const completionText = gameScene.add.text(gameWidth / 2, gameHeight / 2 - 40, 
                `You found all ${words.length} words in ${elapsed} seconds!\n\nYou're a word search master!`, {
                fontSize: '24px',
                fontFamily: 'Arial',
                color: '#ffffff',
                align: 'center',
                lineSpacing: 10
            });
            completionText.setOrigin(0.5);
            completionText.setDepth(201);
            
            // Calculate score
            const score = Math.max(100 - elapsed, 10);
            const result = sendCompletionToWix(activityType, score, elapsed, themeName);
            
            console.log('ðŸŽ¯ Completion result:', result);
            console.log('ðŸ“Š Current difficulty before progression:', difficultyLevel);
            
            // Progress difficulty
            const oldDiff = getDifficultyLevel(difficultyKey);
            progressDifficulty(difficultyKey);
            const newDiff = getDifficultyLevel(difficultyKey);
            
            console.log('ðŸ“ˆ Difficulty progression:', oldDiff, 'â†’', newDiff);
            
            // Check if we've reached max difficulty
            const maxDifficulty = DIFFICULTY_LEVELS[difficultyKey].length;
            const hasMoreLevels = newDiff < maxDifficulty;
            
            console.log('ðŸŽ¯ Max difficulty:', maxDifficulty, '| Has more levels:', hasMoreLevels);
            
            // Show achievements
            if (result.newAchievements && result.newAchievements.length > 0) {
                setTimeout(() => {
                    result.newAchievements.forEach((achievement, index) => {
                        setTimeout(() => showAchievement(achievement), index * 300);
                    });
                }, 1000);
            }
            
            // Next Level or completion button
            if (hasMoreLevels) {
                const nextButton = gameScene.add.graphics();
                nextButton.fillStyle(0x06FFA5, 1);
                nextButton.fillRoundedRect(gameWidth / 2 - 100, gameHeight / 2 + 60, 200, 60, 10);
                nextButton.setDepth(201);
                
                const nextText = gameScene.add.text(gameWidth / 2, gameHeight / 2 + 90, 'Next Level', {
                    fontSize: '28px',
                    fontFamily: 'Arial',
                    color: '#1D3557',
                    fontStyle: 'bold'
                });
                nextText.setOrigin(0.5);
                nextText.setDepth(202);
                nextText.setInteractive({ useHandCursor: true });
                nextText.on('pointerdown', () => {
                    console.log('Next Level clicked - reloading with difficulty:', newDiff);
                    sessionStorage.setItem('skipIntro', 'true');
                    location.reload();
                });
            } else {
                const completeText = gameScene.add.text(gameWidth / 2, gameHeight / 2 + 90, 'ðŸ† All Levels Complete! ðŸ†', {
                    fontSize: '24px',
                    fontFamily: 'Arial',
                    color: '#06FFA5',
                    fontStyle: 'bold'
                });
                completeText.setOrigin(0.5);
                completeText.setDepth(202);
            }
            
            // Back to menu button
            const backText = gameScene.add.text(gameWidth / 2, gameHeight / 2 + 160, 'â† Back to Menu', {
                fontSize: '20px',
                fontFamily: 'Arial',
                color: '#ffffff'
            });
            backText.setOrigin(0.5);
            backText.setDepth(202);
            backText.setInteractive({ useHandCursor: true });
            backText.on('pointerdown', () => {
                console.log('Back to Menu clicked');
                window.location.href = 'index.html';
            });
        }
        
        function update() {
            // Game loop
        }
    </script>
</body>
</html>
